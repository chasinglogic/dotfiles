#!/usr/bin/env -S uv run --script
# vi: ft=python

import argparse
import subprocess
import sys
from typing import List


BANNED_PREFIXES = {
    "KUBERNETES_",
    "HOME",
    "TERM",
    "PATH",
    "HOSTNAME",
}


def dump_vars(kubectl_args: List[str]) -> List[str]:
    """Run `kubectl exec -it ... -- env` and return the raw env lines."""

    cmd = ["kubectl", "exec", "-it", *kubectl_args, "--", "env"]
    try:
        proc = subprocess.run(
            cmd,
            check=True,
            capture_output=True,
            text=True,
        )
    except subprocess.CalledProcessError as exc:  # pragma: no cover - passthrough
        sys.stderr.write(exc.stderr or "kubectl exec failed\n")
        raise SystemExit(exc.returncode)

    return proc.stdout.splitlines()


def is_dumpable_var(env_var: str) -> bool:
    """Return True if this `VAR=VALUE` line should be exported."""

    for prefix in BANNED_PREFIXES:
        if env_var.startswith(prefix):
            return False
    return True


def main(argv: List[str]) -> int:
    parser = argparse.ArgumentParser(
        description="Generate export statements from a pod's environment.",
        add_help=True,
    )
    parser.add_argument(
        "kubectl_args",
        nargs=argparse.REMAINDER,
        help="Arguments to pass to `kubectl exec -it ... -- env`.",
    )

    args = parser.parse_args(argv)

    if not args.kubectl_args:
        parser.error("You must provide arguments for kubectl (e.g. -n ns pod-name)")

    for env_var in dump_vars(args.kubectl_args):
        if is_dumpable_var(env_var):
            print(f"export {env_var}")

    return 0


if __name__ == "__main__":  # pragma: no cover
    raise SystemExit(main(sys.argv[1:]))
