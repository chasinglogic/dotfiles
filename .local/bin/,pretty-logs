#!/usr/bin/env python3
# vi: ft=python

import sys
import json
from dataclasses import dataclass
from typing import Any, Dict


RESET = "\u001b[0m"
RED = "\u001b[31m"
YELLOW = "\u001b[33m"
CYAN = "\u001b[36m"


def color_for_level(level: str) -> str:
    lvl = str(level).upper()
    if lvl == "INFO":
        return CYAN
    if lvl in ("WARN", "WARNING"):
        return YELLOW
    if lvl in ("ERR", "ERROR"):
        return RED
    return RESET


TIMESTAMP_KEYS = ["time", "timestamp", "ts"]
LEVEL_KEYS = ["level", "levelname", "level_name"]
MESSAGE_KEYS = ["message", "msg"]


@dataclass
class LogKeys:
    timestamp: str | None
    level: str | None
    message: str | None


def discover_key(possible_keys, data: Dict[str, Any]) -> str | None:
    for key in possible_keys:
        if key in data:
            return key
    return None


def find_keys(data: Dict[str, Any]) -> LogKeys:
    return LogKeys(
        timestamp=discover_key(TIMESTAMP_KEYS, data),
        level=discover_key(LEVEL_KEYS, data),
        message=discover_key(MESSAGE_KEYS, data),
    )


def print_fields(data: Dict[str, Any], keys: LogKeys, nesting_level: int = 1) -> None:
    exclude = set(filter(None, TIMESTAMP_KEYS + LEVEL_KEYS + MESSAGE_KEYS))
    prefix = "\t" * nesting_level

    for key, val in data.items():
        if key in exclude:
            continue

        if isinstance(val, dict):
            print(f"{prefix}{key} = {{")
            print_fields(val, keys, nesting_level + 1)
            print(f"{prefix}}}")
        elif isinstance(val, list):
            nested = {i: v for i, v in enumerate(val)}
            print(f"{prefix}{key} = {{")
            print_fields(nested, keys, nesting_level + 1)
            print(f"{prefix}}}")
        else:
            print(f"{prefix}{key} = {val}")


def pretty_print(line: str) -> None:
    data = json.loads(line)
    keys = find_keys(data)

    level = data.get(keys.level, "INFO") if keys.level else "INFO"
    timestamp = data.get(keys.timestamp, "") if keys.timestamp else ""
    msg = data.get(keys.message, "") if keys.message else ""

    color = color_for_level(level)
    level_name = str(level).upper()

    print(f"{color}{level_name}{RESET} {timestamp} {msg}")
    print_fields(data, keys, 1)


def main() -> int:
    for line in sys.stdin:
        line = line.rstrip("\n")
        if not line:
            continue
        
        try:
            pretty_print(line)
        except Exception:
            print(f"NON-JSON LINE: {line}")

    return 0


if __name__ == "__main__":
    main()
